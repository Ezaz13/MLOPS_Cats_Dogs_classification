name: Cats and Dogs Classification CI/CD

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

env:
  DOCKER_IMAGE_NAME: cats-dogs-app

jobs:
  build-test-train:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pytest flake8 prefect mlflow scikit-learn pandas numpy matplotlib seaborn great_expectations

    - name: Lint with flake8
      run: |
        flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src tests --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run Unit Tests
      run: |
        pytest tests/

    - name: Execute Data Pipeline & Model Training
      run: |
        python src/data_pipeline_orchestrator/pipeline.py
      env:
        PYTHONIOENCODING: "utf-8"
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}

    - name: Debug - List Files After Training
      if: always()
      run: |
        ls -R
        find . -maxdepth 3 -not -path '*/.*'
        python -c "import mlflow; print('MLflow Tracking URI:', mlflow.get_tracking_uri())"

    - name: Archive Model Performance Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: model-performance-report
        path: src/model_building/model_performance_report.md

    - name: Archive MLflow Runs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-runs
        path: mlruns/
        if-no-files-found: warn

    - name: Archive Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-logs
        path: logs/

    - name: Archive Validation Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: validation-reports
        path: reports/

    - name: Archive MLflow Database
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-db
        path: mlflow.db
        if-no-files-found: warn

    - name: Archive Model Export
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: model-export
        path: models/model_export/
        if-no-files-found: warn

  build-and-deploy:
    needs: build-test-train
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download MLflow Runs
        uses: actions/download-artifact@v4
        with:
          name: mlflow-runs
          path: mlruns

      - name: Download MLflow Database
        uses: actions/download-artifact@v4
        with:
          name: mlflow-db
          path: .

      - name: Download Model Export
        uses: actions/download-artifact@v4
        with:
          name: model-export
          path: models/model_export

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (Local)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
          chmod +x kind
          sudo mv kind /usr/local/bin/kind

      - name: Create Kind cluster
        run: |
          kind create cluster --name mlops-cluster

      - name: Load image into Kind
        run: |
          kind load docker-image \
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} \
            --name mlops-cluster

      - name: Deploy to Kind Kubernetes
        run: |
          kubectl apply -f k8/deployment.yaml
          kubectl apply -f k8/service.yaml

          kubectl set image deployment/cats-dogs-app \
            cats-dogs-app=${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

      - name: Verify rollout
        run: |
          kubectl rollout status deployment/cats-dogs-app

      - name: Show cluster status
        run: |
          kubectl get pods -o wide
          kubectl get services
          
      - name: Wait for service readiness
        run: |
          kubectl wait --for=condition=available --timeout=300s deployment/cats-dogs-app
          sleep 10

      - name: Run Smoke Tests
        run: |
          # Port forward in background
          kubectl port-forward service/cats-dogs-service 5000:5000 &
          PID=$!
          sleep 5
          
          # Run python smoke test
          export SERVICE_URL="http://localhost:5000"
          python tests/smoke_test.py
          
          # Kill port forward
          kill $PID

          
